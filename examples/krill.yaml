version: "1"
name: robot
log_dir: ~/.krill/logs

env:
  ROBOT_ID: robot-001
  ROS_DOMAIN_ID: "42"

services:
  lidar:
    execute:
      type: pixi
      task: start-lidar
      environment: drivers
      stop_task: stop-lidar
    critical: true
    health_check:
      type: heartbeat
      timeout: 2s
    policy:
      restart: on-failure
      max_restarts: 3
      restart_delay: 5s
      stop_timeout: 10s

  localization:
    execute:
      type: pixi
      task: localization
      environment: slam
    dependencies:
      - lidar: healthy
    health_check:
      type: tcp
      port: 5555
      timeout: 1s
    policy:
      restart: on-failure
      max_restarts: 5

  navigator:
    execute:
      type: pixi
      task: navigate
      environment: navigation
    dependencies:
      - localization: healthy
      - lidar
    health_check:
      type: http
      port: 8080
      path: /health
      expected_status: 200
    policy:
      restart: always

  vision:
    execute:
      type: pixi
      task: vision-pipeline
      environment: perception
    gpu: true
    health_check:
      type: heartbeat
      timeout: 1s
    policy:
      restart: always
      restart_delay: 2s

  control:
    execute:
      type: ros2
      package: robot_control
      launch_file: control.launch.py
      launch_args:
        use_sim_time: "false"
        controller_type: "mpc"
      stop_task: shutdown-controllers
    dependencies:
      - navigator: healthy
      - vision
    health_check:
      type: tcp
      port: 9090
      timeout: 1s

  diagnostics:
    execute:
      type: shell
      command: python3 diagnostics_monitor.py --interval 1
      stop_command: python3 diagnostics_monitor.py --shutdown
      working_dir: /opt/robot/diagnostics
    health_check:
      type: script
      command: curl -f http://localhost:8081/alive
      timeout: 500ms
